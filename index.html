<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font Awesome (icons) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap');
    :root{
      --bg:#fef7f2;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#5b6474;
      --border:#e2e8f0;
      --accent:#d946ef;
      --accent-2:#f97316;
      --accent-soft:#fff1f7;
      --danger:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at 10% 20%, #fff7fb 0, #fff4ef 32%, #fef7f2 60%);
      color: var(--ink);
      padding: 18px;
    }
    .wrap{
      max-width: 1180px;
      margin:0 auto;
      display:grid;
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 14px 50px rgba(15,23,42,.06);
    }
    .card.frosted{
      backdrop-filter: blur(10px);
      border-color: rgba(217,70,239,.18);
    }
    h1{
      margin:0 0 4px 0;
      font-size:22px;
      letter-spacing:-0.4px;
    }
    .sub{
      font-size:14px;
      color:var(--muted);
      max-width: 720px;
    }

    /* Layout */
    .grid{
      display:grid;
      gap:12px;
    }
    @media(min-width:900px){
      .grid.cols-2{grid-template-columns: 1.1fr .9fr;}
      .grid.cols-3{grid-template-columns: repeat(3,1fr);}
    }

    /* Segmented toggle w/ sliding highlight */
    .seg{
      position:relative;
      display:flex;
      background:linear-gradient(180deg, #f8fafc, #f1f5f9);
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px;
      gap:4px;
      overflow:hidden;
      box-shadow:0 10px 26px rgba(15,23,42,.05);
    }
    .seg .slider{
      position:absolute;
      top:4px; bottom:4px;
      left:4px;
      width:calc((100% - 8px) / var(--count));
      background: linear-gradient(135deg, #e2e6ea, #f1f2f4);
      border-radius:999px;
      box-shadow:0 3px 8px rgba(15,23,42,.08);
      transition: transform .25s ease;
      transform: translateX(calc(var(--index) * 100%));
      z-index:0;
    }
    .seg button{
      position:relative;
      z-index:1;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:none;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      color:var(--muted);
      transition: color .2s ease, transform .05s ease;
      white-space:nowrap;
    }
    .seg button .aspect-icon{
      display:inline-block;
      width:14px; height:14px;
      border:2px solid #d5deeb;
      border-radius:7px;
      background:#fff;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.25);
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .seg button .aspect-icon.square{width:16px; height:16px;}
    .seg button .aspect-icon.portrait{width:12px; height:18px;}
    .seg button .aspect-icon.landscape{width:18px; height:12px;}
    .seg button.active{
      color:var(--ink);
      font-weight:700;
      transform:translateY(-0.5px);
      background: linear-gradient(180deg, #f1f1f5, #e3e6eb);
    }
    .seg button.active .aspect-icon{
      border-color:#c0c9d9;
      box-shadow: inset 0 0 0 1px rgba(51,65,85,.35);
    }
    .seg button:active{transform:translateY(1px);}

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }

    .label{
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 4px;
    }

    .prompt-row{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .prompt-row .prompt-input{flex:1;}
    .helper-row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .helper-row .field{flex:1; min-width:240px;}

    textarea, input[type="text"]{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:15px;
      outline:none;
      background:#fff;
      box-shadow:0 12px 30px rgba(15,23,42,.04);
    }
    textarea{min-height:120px; resize:vertical; font-family:"Space Grotesk", "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;}
    textarea::placeholder{color:#94a3b8;}

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      box-shadow:0 12px 30px rgba(15,23,42,.05);
    }
    .btn:hover{border-color:#cbd5e1; background:#fafafa;}
    .btn:active{transform:translateY(1px);}
    .btn.primary{
      background:linear-gradient(120deg, var(--accent), var(--accent-2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 12px 35px rgba(217,70,239,.28);
    }
    .btn.primary:hover{filter:brightness(1.05);}
    .btn.danger{color:#b91c1c; border-color:#fecaca; background:#fff5f5;}
    .btn.small{padding:7px 10px; font-size:13px; border-radius:10px;}
    .btn.icon-only{padding:7px 10px; width:36px; justify-content:center;}

    .shortcut{
      font-size:12px;
      color:var(--muted);
      font-weight:500;
      margin-left:6px;
    }

    .actions{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    .actions.action-row,
    .actions.queue-actions{
      justify-content:center;
      flex-wrap:nowrap;
      width:100%;
    }
    .actions.action-row .btn,
    .actions.queue-actions .btn,
    .actions.queue-actions .status{
      white-space:nowrap;
    }
    .status{
      font-size:14px; color:var(--muted);
    }
    .status.error{color:var(--danger);}

    /* Queue list */
    .queue{
      display:grid; gap:8px; margin-top:8px;
      max-height:260px; overflow:auto; padding-right:2px;
    }
    .q-item{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:8px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      background:#fff;
      align-items:center;
    }
    .q-meta{
      font-size:12px; color:var(--muted);
      display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;
    }
    .q-status{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pill{
      font-size:12px; background:#f1f5f9; padding:2px 7px; border-radius:999px;
    }

    /* Output gallery */
    .out-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
      gap:12px; margin-top:10px;
    }
    .out-item{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      display:grid;
      box-shadow:0 12px 30px rgba(15,23,42,.06);
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .out-item:hover{transform:translateY(-2px); box-shadow:0 14px 40px rgba(15,23,42,.08);}
    .out-item img{
      width:100%; height:auto; display:block;
      cursor:zoom-in;
    }
    .out-meta{
      padding:10px 12px;
      font-size:12px; color:var(--muted);
      display:grid; gap:6px;
    }
    .out-row{
      display:flex; flex-wrap:wrap; gap:6px; align-items:center;
    }
    .download{
      margin-left:auto;
      text-decoration:none;
      color:var(--ink);
      font-weight:700;
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      padding:5px 8px; border-radius:10px;
      background:#fff;
    }
    .download:hover{background:#fafafa; border-color:#cbd5e1;}
    code.small{
      font-size:11px; background:#f8fafc; padding:2px 5px; border-radius:6px;
      border:1px solid var(--border); color:#334155;
      word-break:break-all;
    }

    .seg.small button{font-size:13px;}

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:1000;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .modal-backdrop.show{
      opacity:1;
      pointer-events:auto;
    }
    .modal-content{
      background:#0f172a;
      border-radius:16px;
      overflow:hidden;
      max-width:90vw;
      max-height:90vh;
      box-shadow:0 24px 80px rgba(0,0,0,.35);
      position:relative;
    }
    .modal-content img{
      display:block;
      width:100%;
      height:auto;
      max-height:90vh;
      object-fit:contain;
      background:#0b1223;
    }
    .modal-close{
      position:absolute;
      top:10px;
      right:10px;
      border:none;
      width:32px;
      height:32px;
      border-radius:50%;
      background:rgba(15,23,42,.75);
      color:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
    }
    .modal-close:hover{transform:translateY(-1px); box-shadow:0 14px 30px rgba(0,0,0,.28); background:rgba(15,23,42,.9);}
    .modal-close:active{transform:translateY(1px);}

    .modal-content.dialog{
      background:#fff;
      color:var(--ink);
      padding:28px 26px 24px;
      max-width:480px;
      width:100%;
      box-shadow:0 24px 70px rgba(15,23,42,.12);
      border:1px solid rgba(15,23,42,.06);
      display:grid;
      gap:12px;
    }
    .modal-content.dialog h3{
      margin:0;
      font-size:20px;
      letter-spacing:-0.3px;
    }
    .modal-content.dialog p{margin:0; color:var(--muted); line-height:1.5;}
    .modal-content.dialog .modal-close{
      background:rgba(15,23,42,.06);
      color:var(--ink);
      box-shadow:0 12px 30px rgba(15,23,42,.12);
    }
    .confirm-header{display:flex; gap:14px; align-items:flex-start;}
    .confirm-icon{width:46px; height:46px; border-radius:14px; display:grid; place-items:center; background:rgba(239,68,68,.08); color:var(--danger); font-size:18px; box-shadow: inset 0 0 0 1px rgba(239,68,68,.12);}
    .confirm-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:6px;}
    .confirm-actions .btn{box-shadow:none;}
    .confirm-actions .btn.danger{background:linear-gradient(120deg, #ef4444, #f97316); color:#fff; border-color:transparent; box-shadow:0 12px 35px rgba(239,68,68,.28);}
    .confirm-actions .btn.danger:hover{filter:brightness(1.02);}

    /* Header */
    .hero{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .logo{
      width:48px; height:48px;
      border-radius:14px;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      display:grid; place-items:center;
      box-shadow:0 12px 30px rgba(217,70,239,.35);
      overflow:hidden;
    }
    .logo img{
      width:38px; height:38px;
      object-fit:cover;
      border-radius:10px;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,.18));
    }
    .pill.soft{background:var(--accent-soft); color:var(--accent); font-weight:700;}
    .section-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      color:var(--ink);
      margin-bottom:4px;
    }
    .section-actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
    }

    @media(max-width:720px){
      body{padding:14px;}
      .card{padding:14px;}
      .hero{flex-direction:column; align-items:flex-start;}
      .actions{gap:6px;}
      .actions.action-row,
      .actions.queue-actions{flex-wrap:wrap; justify-content:center;}
      .seg button{padding:8px 10px;}
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="hero">
    <div class="logo">
      <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDY0IDY0IiBmaWxsPSJub25lIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZyIgeDE9IjgiIHkxPSI4IiB4Mj0iNTYiIHkyPSI1NiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgogICAgICA8c3RvcCBzdG9wLWNvbG9yPSIjZDk0NmVmIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2Y5NzMxNiIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ2xvdyIgeDE9IjE2IiB5MT0iMTYiIHgyPSI0OCIgeTI9IjQ4IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CiAgICAgIDxzdG9wIHN0b3AtY29sb3I9IiNmZGU2OGEiIHN0b3Atb3BhY2l0eT0iMC44NSIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNmOWE4ZDQiIHN0b3Atb3BhY2l0eT0iMC45Ii8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHJ4PSIxNCIgZmlsbD0idXJsKCNnKSIvPgogIDxyZWN0IHg9IjEyIiB5PSIxMiIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iMTIiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4yKSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMTEiIGZpbGw9InVybCgjZ2xvdykiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgLz4KICA8cGF0aCBkPSJNMjIgNDJjMC01LjUyMyA0LjQ3Ny0xMCAxMC0xMHMxMCA0LjQ3NyAxMCAxMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIG9wYWNpdHk9IjAuOSIvPgogIDxjaXJjbGUgY3g9IjI2IiBjeT0iMjgiIHI9IjMiIGZpbGw9IndoaXRlIi8+CiAgPGNpcmNsZSBjeD0iMzgiIGN5PSIyNiIgcj0iNCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==" alt="Image Creator avatar" />
    </div>
    <div>
      <h1>Image Creator</h1>
    </div>
  </div>

  <!-- Controls + Queue -->
  <div class="grid cols-2">

    <!-- Left: Controls -->
    <div class="card grid" style="gap:10px;">
      <div class="grid cols-3" style="gap:10px;">
        <div>
          <div class="label">Quality</div>
          <div class="seg" id="qualitySeg" style="--count:3; --index:0;">
            <div class="slider"></div>
            <button data-value="low" class="active">Fast</button>
            <button data-value="medium">Med</button>
            <button data-value="high">Slow</button>
          </div>
        </div>
        <div>
          <div class="label">Size</div>
          <div class="seg" id="sizeSeg" style="--count:3; --index:0;">
            <div class="slider"></div>
            <button data-value="1024x1024" data-label="Square" aria-label="Square" title="Square">
              <span class="aspect-icon square"></span>
              <span class="sr-only">Square</span>
            </button>
            <button data-value="1024x1536" data-label="Portrait" aria-label="Portrait" title="Portrait">
              <span class="aspect-icon portrait"></span>
              <span class="sr-only">Portrait</span>
            </button>
            <button data-value="1536x1024" data-label="Landscape" aria-label="Landscape" title="Landscape">
              <span class="aspect-icon landscape"></span>
              <span class="sr-only">Landscape</span>
            </button>
          </div>
        </div>
        <div>
          <div class="label">Input mode</div>
          <div class="seg" id="inputSeg" style="--count:3; --index:0;">
            <div class="slider"></div>
            <button data-value="prompt" class="active">Orginal</button>
            <button data-value="enhanced">GPT5.2</button>
            <button data-value="json">JSON</button>
          </div>
        </div>
      </div>

      <div>
        <div class="label">Prompt</div>
        <div class="prompt-row">
          <textarea class="prompt-input" id="prompt" placeholder="Write a prompt you love, then queue it up."></textarea>
        </div>
      </div>

      <div class="actions action-row">
        <button class="btn primary" id="addBtn"><i class="fa-solid fa-plus"></i> Add to Queue</button>
      </div>
    </div>

    <!-- Right: Queue -->
    <div class="card">
      <div class="section-title">
        Queue
        <div class="section-actions">
          <span class="pill soft" id="qCount">0 jobs</span>
          <button class="btn danger small icon-only" id="clearQueueBtn" aria-label="Clear all queue items">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>

      <div class="actions queue-actions" style="margin-bottom:6px;">
        <button class="btn primary" id="runBtn">
          <i class="fa-solid fa-play"></i> Start Queue
        </button>
        <span class="status" id="status"></span>
      </div>

      <div class="queue" id="queue"></div>
    </div>
  </div>

  <!-- Output -->
  <div class="card">
    <div class="section-title">
      Your Images
      <div class="section-actions">
        <button class="btn small" id="downloadAllBtn"><i class="fa-solid fa-download"></i> Download All</button>
        <button class="btn small" id="clearOutBtn"><i class="fa-solid fa-broom"></i> Remove</button>
      </div>
    </div>
    <div class="out-grid" id="output"></div>
  </div>

</div>

<div class="modal-backdrop" id="confirmModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-content dialog">
    <button class="modal-close" id="closeConfirm" aria-label="Close confirmation dialog">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <div class="confirm-header">
      <div class="confirm-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
      <div>
        <h3 id="confirmTitle">Clear saved images?</h3>
        <p id="confirmMessage">This will remove all saved images from this browser. You won't be able to undo this.</p>
      </div>
    </div>
    <div class="confirm-actions">
      <button class="btn" id="cancelConfirm">Cancel</button>
      <button class="btn danger" id="confirmPrimary">Delete all</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="imageModal" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" id="closeModal" aria-label="Close image preview">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <img id="modalImage" alt="Preview" />
  </div>
</div>

<script>
  // ---------- Segmented controls w/ sliding highlight ----------
  function setupSeg(id, defaultValue, withLabel=false){
    const seg = document.getElementById(id);
    const buttons = Array.from(seg.querySelectorAll("button"));
    let value = defaultValue;
    let label = buttons.find(b=>b.dataset.value===defaultValue)?.dataset.label || "";

    function setActive(idx){
      buttons.forEach(b=>b.classList.remove("active"));
      buttons[idx].classList.add("active");
      seg.style.setProperty("--index", idx);
      value = buttons[idx].dataset.value;
      label = buttons[idx].dataset.label || buttons[idx].textContent.trim();
    }
    buttons.forEach((btn, idx)=>{
      btn.addEventListener("click", ()=> setActive(idx));
    });
    // init
    const defIdx = buttons.findIndex(b=>b.dataset.value===defaultValue);
    setActive(defIdx >= 0 ? defIdx : 0);

    return ()=> withLabel ? { value, label } : value;
  }

  const QUALITY_LABELS = {
    low: "Low",
    medium: "Med",
    high: "High"
  };

  const SIZE_LABELS = {
    "1024x1024": "Square",
    "1024x1536": "Portrait",
    "1536x1024": "Landscape"
  };

  const getQuality = setupSeg("qualitySeg", "low");
  const getSize = setupSeg("sizeSeg", "1024x1024", true);
  const getInputMode = setupSeg("inputSeg", "prompt");

  function syncPromptPlaceholder(mode){
    if(mode === "json"){
      promptEl.placeholder = 'Paste JSON here (array or { "jobs": [] }). Each entry becomes a job.';
    }else if(mode === "enhanced"){
      promptEl.placeholder = "Write a prompt to enhance with GPT5.2, then queue it up.";
    }else{
      promptEl.placeholder = "Write a prompt you love, then queue it up.";
    }
  }

  const inputSegEl = document.getElementById("inputSeg");

  // ---------- Elements ----------
  const promptEl = document.getElementById("prompt");
  const queueEl = document.getElementById("queue");
  const outputEl = document.getElementById("output");
  const statusEl = document.getElementById("status");
  const qCountEl = document.getElementById("qCount");
  const imageModalEl = document.getElementById("imageModal");
  const modalImageEl = document.getElementById("modalImage");
  const closeModalEl = document.getElementById("closeModal");
  const confirmModalEl = document.getElementById("confirmModal");
  const closeConfirmEl = document.getElementById("closeConfirm");
  const cancelConfirmEl = document.getElementById("cancelConfirm");
  const confirmPrimaryEl = document.getElementById("confirmPrimary");
  const confirmTitleEl = document.getElementById("confirmTitle");
  const confirmMessageEl = document.getElementById("confirmMessage");

  const addBtn = document.getElementById("addBtn");
  const clearQueueBtn = document.getElementById("clearQueueBtn");
  const runBtn = document.getElementById("runBtn");
  const clearOutBtn = document.getElementById("clearOutBtn");
  const downloadAllBtn = document.getElementById("downloadAllBtn");

  inputSegEl.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", ()=> syncPromptPlaceholder(getInputMode()));
  });
  syncPromptPlaceholder(getInputMode());

  const DEFAULT_MODEL = "gpt-image-1";
  const STORAGE_KEY = "image-generator-outputs";
  const savedOutputs = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  async function compressForStorage(dataUrl){
    return new Promise(resolve => {
      const img = new Image();
      img.onload = ()=>{
        try{
          const maxSide = 1024;
          const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
          const canvas = document.createElement("canvas");
          canvas.width = Math.max(1, Math.round(img.width * scale));
          canvas.height = Math.max(1, Math.round(img.height * scale));
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          // Use JPEG to shrink the payload to stay below localStorage limits
          resolve(canvas.toDataURL("image/jpeg", 0.76));
        }catch(err){
          console.warn("Failed to compress image for storage", err);
          resolve(dataUrl);
        }
      };
      img.onerror = ()=> resolve(dataUrl);
      img.src = dataUrl;
    });
  }

  function setStatus(msg, isError=false){
    statusEl.textContent = msg || "";
    statusEl.classList.toggle("error", !!isError);
  }

  function persistOutputs(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedOutputs));
    }catch(err){
      console.warn("Could not persist outputs", err);
      setStatus("Could not save images locally because storage is full.", true);
    }
  }

  function openModal(src, alt){
    modalImageEl.src = src;
    modalImageEl.alt = alt || "Preview";
    imageModalEl.classList.add("show");
    imageModalEl.setAttribute("aria-hidden", "false");
  }

  function closeModal(){
    imageModalEl.classList.remove("show");
    imageModalEl.setAttribute("aria-hidden", "true");
    modalImageEl.src = "";
  }

  imageModalEl.addEventListener("click", (e)=>{
    if(e.target === imageModalEl) closeModal();
  });
  closeModalEl.addEventListener("click", closeModal);

  // ---------- Confirmation modal ----------
  let confirmAction = null;
  let confirmCancelAction = null;
  let confirmResolver = null;

  function finalizeConfirm(result){
    if(confirmResolver){
      confirmResolver(result);
      confirmResolver = null;
    }
  }

  function openConfirmDialog({ title, message, confirmLabel, variant="danger", onConfirm, onCancel, returnPromise=false }){
    confirmTitleEl.textContent = title;
    confirmMessageEl.textContent = message;
    confirmPrimaryEl.textContent = confirmLabel;
    confirmPrimaryEl.className = "btn";
    if(variant === "danger") confirmPrimaryEl.classList.add("danger");
    if(variant === "primary") confirmPrimaryEl.classList.add("primary");
    confirmAction = ()=>{
      onConfirm?.();
      finalizeConfirm(true);
      closeConfirmDialog(true);
    };
    confirmCancelAction = ()=>{
      onCancel?.();
      finalizeConfirm(false);
      closeConfirmDialog(true);
    };

    let promise;
    if(returnPromise){
      promise = new Promise(resolve => { confirmResolver = resolve; });
    }

    confirmModalEl.classList.add("show");
    confirmModalEl.setAttribute("aria-hidden", "false");
    confirmPrimaryEl.focus();

    return promise;
  }

  function confirmDialogAsync(opts){
    return openConfirmDialog({ ...opts, returnPromise: true });
  }

  function closeConfirmDialog(skipResolve=false){
    confirmModalEl.classList.remove("show");
    confirmModalEl.setAttribute("aria-hidden", "true");
    if(!skipResolve) finalizeConfirm(false);
    confirmAction = null;
    confirmCancelAction = null;
  }

  confirmModalEl.addEventListener("click", (e)=>{
    if(e.target === confirmModalEl){
      if(confirmCancelAction) confirmCancelAction();
      else closeConfirmDialog();
    }
  });
  closeConfirmEl.addEventListener("click", ()=>{
    if(confirmCancelAction) confirmCancelAction();
    else closeConfirmDialog();
  });
  cancelConfirmEl.addEventListener("click", ()=>{
    if(confirmCancelAction) confirmCancelAction();
    else closeConfirmDialog();
  });
  confirmPrimaryEl.addEventListener("click", ()=> confirmAction?.());
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){ closeModal(); closeConfirmDialog(); }
    if(e.key === "Enter" && confirmModalEl.classList.contains("show")){
      e.preventDefault();
      confirmAction?.();
    }
  });

  // ---------- Queue state ----------
  const jobs = [];
  let running = false;
  let stopRequested = false;

  function updateRunButton(state="idle"){
    if(state === "running"){
      runBtn.innerHTML = `<i class="fa-solid fa-stop"></i> Stop After Current`;
    }else if(state === "stopping"){
      runBtn.innerHTML = `<i class="fa-solid fa-hourglass-half"></i> Stopping…`;
    }else{
      runBtn.innerHTML = `<i class="fa-solid fa-play"></i> Start Queue`;
    }
  }

  function setJobStatus(index, status){
    if(!jobs[index]) return;
    jobs[index].status = status || "";
    renderQueue();
  }

  function renderQueue(){
    queueEl.innerHTML = "";
    jobs.forEach((job, i)=>{
      const div = document.createElement("div");
      div.className = "q-item";
      div.innerHTML = `
        <div>
          <div><strong>#${i+1}</strong> ${job.prompt}</div>
          ${job.status ? `<div class="q-status">${job.status}</div>` : ""}
          <div class="q-meta">
            <span class="pill">${QUALITY_LABELS[job.quality] || job.quality}</span>
            <span class="pill">${job.sizeLabel || job.size}</span>
          <span class="pill">Source: ${job.inputMode || (job.enhance === "yes" ? "GPT5.2" : "Orginal")}</span>
          </div>
        </div>
        <div class="actions" style="justify-content:flex-end;">
          <button class="btn small danger" data-remove="${i}">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      `;
      queueEl.appendChild(div);
    });

    qCountEl.textContent = `${jobs.length} job${jobs.length===1?"":"s"}`;
    // remove buttons
    queueEl.querySelectorAll("[data-remove]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.dataset.remove);
        jobs.splice(idx,1);
        renderQueue();
      });
    });
  }

  function addJob(prompt, opts={}){
    const sizeSelection = opts.size
      ? { value: opts.size, label: opts.sizeLabel || SIZE_LABELS[opts.size] || opts.size }
      : getSize();
    jobs.push({
      prompt,
      model: DEFAULT_MODEL,
      quality: opts.quality || getQuality(),
      size: sizeSelection.value,
      sizeLabel: sizeSelection.label,
      enhance: opts.enhance || "no",
      inputMode: opts.inputMode || "Orginal"
    });
    renderQueue();
  }

  function addJobsFromInputs(){
    const mode = getInputMode();

    if(mode === "json"){
      const raw = promptEl.value.trim();
      if(!raw) return setStatus("Add JSON input first.", true);

      let parsed;
      try{
        parsed = JSON.parse(raw);
      }catch(err){
        return setStatus("Invalid JSON. Please check the syntax.", true);
      }

      const entries = Array.isArray(parsed) ? parsed : (Array.isArray(parsed?.jobs) ? parsed.jobs : null);
      if(!entries) return setStatus("JSON must be an array or { jobs: [] }.", true);

      const defaultSize = getSize();
      let added = 0;
      entries.forEach(entry => {
        let prompt = "";
        let quality = getQuality();
        let size = defaultSize.value;
        let enhance = "no";

        if(typeof entry === "string"){
          prompt = entry;
        }else if(entry && typeof entry === "object"){
          prompt = entry.prompt || "";
          quality = entry.quality || quality;
          size = entry.size || size;
          if(entry.enhance === true || entry.enhance === "yes") enhance = "yes";
        }

        if(!prompt) return;

        addJob(prompt, {
          quality,
          size,
          sizeLabel: SIZE_LABELS[size] || size,
          enhance,
          inputMode: "JSON"
        });
        added++;
      });

      if(added === 0) return setStatus("No jobs created from JSON.", true);

      promptEl.value = "";
      setStatus(`Added ${added} job${added===1?"":"s"} from JSON.`);
      return true;
    }

    const p = promptEl.value.trim();
    if(!p) return setStatus("Add a prompt first.", true);

    const enhanceValue = mode === "enhanced" ? "yes" : "no";
    addJob(p, {
      enhance: enhanceValue,
      inputMode: mode === "enhanced" ? "GPT5.2" : "Orginal"
    });
    promptEl.value = "";
    setStatus("");
    return true;
  }

  addBtn.addEventListener("click", addJobsFromInputs);

  function requestQueueKickoff(){
    if(running) return;
    if(jobs.length===0) return setStatus("Queue is empty.", true);
    openConfirmDialog({
      title: "Start your queue?",
      message: "No prompt is entered. Do you want to kick off the queued jobs now?",
      confirmLabel: "Start creating",
      variant: "primary",
      onConfirm: ()=>{ closeConfirmDialog(); runQueue(); }
    });
  }

  promptEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && e.ctrlKey){
      e.preventDefault();
      if(!promptEl.value.trim() && jobs.length>0) return requestQueueKickoff();
      addJobsFromInputs();
    }
  });

  clearQueueBtn.addEventListener("click", ()=>{
    openConfirmDialog({
      title: "Clear the entire queue?",
      message: "All queued prompts will be removed. This won't affect saved images.",
      confirmLabel: "Clear queue",
      onConfirm: ()=>{
        jobs.length = 0;
        renderQueue();
        setStatus("");
        closeConfirmDialog();
      }
    });
  });

  clearOutBtn.addEventListener("click", ()=>{
    openConfirmDialog({
      title: "Remove saved images?",
      message: "This will remove every saved image from this browser. This can't be undone.",
      confirmLabel: "Remove all",
      onConfirm: ()=>{
        outputEl.innerHTML = "";
        savedOutputs.length = 0;
        persistOutputs();
        closeConfirmDialog();
      }
    });
  });

  function triggerDownload(dataUrl, filename){
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = filename || "image.png";
    document.body.appendChild(link);
    link.click();
    link.remove();
  }

  downloadAllBtn.addEventListener("click", ()=>{
    const images = Array.from(outputEl.querySelectorAll(".out-item img"));
    if(images.length === 0) return setStatus("No images to download.", true);
    images.forEach((img, idx)=>{
      const name = img.dataset.filename || `image-${idx+1}.png`;
      triggerDownload(img.src, name);
    });
    setStatus(`Downloading ${images.length} image${images.length===1?"":"s"}…`);
  });

  // ---------- Output cards ----------
  function addOutputCard({ dataUrl, prompt, model, quality, size, sizeLabel, enhance, inputMode, createdAt }, shouldSave=true){
    const item = document.createElement("div");
    const created = createdAt || Date.now();
    item.className = "out-item";
    item.dataset.createdAt = String(created);

    const filename = (prompt.slice(0,40).replace(/[^\w\-]+/g,"_") || "image") + ".png";
    item.innerHTML = `
      <img src="${dataUrl}" alt="${prompt.replace(/"/g,"&quot;")}" data-filename="${filename}"/>
      <div class="out-meta">
        <div class="out-row">
          <span class="pill">${QUALITY_LABELS[quality] || quality}</span>
          <span class="pill">${sizeLabel || size}</span>
          <span class="pill">Source: ${inputMode || (enhance === "yes" ? "GPT5.2" : "Orginal")}</span>

          <a class="download" download="${filename}" href="${dataUrl}">
            <i class="fa-solid fa-download"></i> Download
          </a>
          <button class="btn small danger icon-only" data-delete aria-label="Delete image">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
        <div>${prompt}</div>
      </div>
    `;
    const imgEl = item.querySelector("img");
    imgEl.addEventListener("click", ()=> openModal(dataUrl, prompt));

    const deleteBtn = item.querySelector("[data-delete]");
    const removeSavedCopy = ()=>{
      const idx = savedOutputs.findIndex(o => String(o.createdAt) === String(created));
      if(idx >= 0){
        savedOutputs.splice(idx,1);
        persistOutputs();
      }
    };
    deleteBtn.addEventListener("click", ()=>{
      openConfirmDialog({
        title: "Delete this image?",
        message: "Removing this card will delete the saved copy from your browser.",
        confirmLabel: "Delete image",
        onConfirm: ()=>{
          item.remove();
          removeSavedCopy();
          closeConfirmDialog();
        }
      });
    });

    outputEl.prepend(item);

    if(shouldSave){
      const entry = { dataUrl, prompt, model, quality, size, sizeLabel, enhance, createdAt: created };
      // Compress before persisting to reduce localStorage footprint
      compressForStorage(dataUrl).then(minifiedDataUrl => {
        // If the card was deleted before compression finishes, skip saving.
        if(!item.isConnected) return;
        const stored = { ...entry, dataUrl: minifiedDataUrl };
        savedOutputs.unshift(stored);
        if(savedOutputs.length > 20) savedOutputs.length = 20;
        persistOutputs();
      });
    }
  }

  savedOutputs.forEach(entry => addOutputCard(entry, false));

  async function enhancePrompt(prompt){
    const res = await fetch("/api/enhance-prompt", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ prompt })
    });
    const text = await res.text().catch(()=> "");
    if(!res.ok) throw new Error(text || `Enhance failed (${res.status})`);
    const data = JSON.parse(text || "{}");
    return data.prompt || prompt;
  }

  // ---------- API call ----------
  async function generateOne(job){
    const res = await fetch("/api/generate-image",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        prompt: job.prompt,
        model: DEFAULT_MODEL,
        quality: job.quality,
        size: job.size,
        n: 1
      })
    });
    const text = await res.text().catch(()=> "");
    if(!res.ok) throw new Error(text || `Request failed (${res.status})`);
    return JSON.parse(text);
  }

  // ---------- Run queue sequentially ----------
  async function runQueue(){
    if(running) return;
    if(jobs.length===0) return setStatus("Queue is empty.", true);

    running = true;
    stopRequested = false;
    jobs.forEach(job => delete job.status);
    renderQueue();
    updateRunButton("running");
    setStatus("");

    try{
      while(jobs.length > 0){
        const job = jobs[0];

        let workingPrompt = job.prompt;
        if(job.enhance === "yes"){
          setJobStatus(0, "Enhancing with GPT5.2");
          workingPrompt = await enhancePrompt(workingPrompt);
        }

        setJobStatus(0, "Creating");

        const data = await generateOne({ ...job, prompt: workingPrompt });
        // expecting { images: [{ dataUrl }] }
        const img = data?.images?.[0];
        if(!img?.dataUrl) throw new Error("No image returned.");

        addOutputCard({
          dataUrl: img.dataUrl,
          prompt: workingPrompt,
          model: DEFAULT_MODEL,
          quality: job.quality,
          size: job.size,
          sizeLabel: job.sizeLabel,
          enhance: job.enhance,
          inputMode: job.inputMode
        });

        jobs.shift();
        renderQueue();

        if(stopRequested){
          setStatus("Stopped after current job.");
          break;
        }
      }
      if(!stopRequested) setStatus("");
    }catch(err){
      console.error(err);
      setStatus(err.message || "Something went wrong.", true);
    }finally{
      running = false;
      stopRequested = false;
      updateRunButton("idle");
    }
  }

  runBtn.addEventListener("click", ()=>{
    if(running){
      if(!stopRequested){
        stopRequested = true;
        updateRunButton("stopping");
        setStatus("Stop requested… will stop after current job.");
      }
      return;
    }
    runQueue();
  });

  renderQueue();
</script>
</body>
</html>
