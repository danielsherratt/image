<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font Awesome (icons) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap');
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#5b6474;
      --border:#e2e8f0;
      --accent:#4f46e5;
      --accent-2:#06b6d4;
      --accent-soft:#eef2ff;
      --danger:#ef4444;
      --radius:16px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at 10% 20%, #eef2ff 0, #f8fafc 32%, #f4f6fb 60%);
      color: var(--ink);
      padding: 18px;
    }
    .wrap{
      max-width: 1180px;
      margin:0 auto;
      display:grid;
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 14px 50px rgba(15,23,42,.06);
    }
    .card.frosted{
      backdrop-filter: blur(10px);
      border-color: rgba(79,70,229,.15);
    }
    h1{
      margin:0 0 4px 0;
      font-size:22px;
      letter-spacing:-0.4px;
    }
    .sub{
      font-size:14px;
      color:var(--muted);
      max-width: 720px;
    }

    /* Layout */
    .grid{
      display:grid;
      gap:12px;
    }
    @media(min-width:900px){
      .grid.cols-2{grid-template-columns: 1.1fr .9fr;}
      .grid.cols-3{grid-template-columns: repeat(3,1fr);}
    }

    /* Segmented toggle w/ sliding highlight */
    .seg{
      position:relative;
      display:flex;
      background:linear-gradient(180deg, #f8fafc, #f1f5f9);
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px;
      gap:4px;
      overflow:hidden;
      box-shadow:0 10px 26px rgba(15,23,42,.05);
    }
    .seg .slider{
      position:absolute;
      top:4px; bottom:4px;
      left:4px;
      width:calc((100% - 8px) / var(--count));
      background: linear-gradient(135deg, #e2e6ea, #f1f2f4);
      border-radius:999px;
      box-shadow:0 3px 8px rgba(15,23,42,.08);
      transition: transform .25s ease;
      transform: translateX(calc(var(--index) * 100%));
      z-index:0;
    }
    .seg button{
      position:relative;
      z-index:1;
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:none;
      background:linear-gradient(180deg, #ffffff, #f8fafc);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      color:var(--muted);
      transition: color .2s ease, transform .05s ease;
      white-space:nowrap;
    }
    .seg button .aspect-icon{
      display:inline-block;
      width:14px; height:14px;
      border:2px solid #d5deeb;
      border-radius:7px;
      background:#fff;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,.25);
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .seg button .aspect-icon.square{width:16px; height:16px;}
    .seg button .aspect-icon.portrait{width:12px; height:18px;}
    .seg button .aspect-icon.landscape{width:18px; height:12px;}
    .seg button.active{
      color:var(--ink);
      font-weight:700;
      transform:translateY(-0.5px);
      background: linear-gradient(180deg, #f1f1f5, #e3e6eb);
    }
    .seg button.active .aspect-icon{
      border-color:#c0c9d9;
      box-shadow: inset 0 0 0 1px rgba(51,65,85,.35);
    }
    .seg button:active{transform:translateY(1px);}

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      border:0;
    }

    .label{
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 4px;
    }

    textarea, input[type="text"]{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:15px;
      outline:none;
      background:#fff;
      box-shadow:0 12px 30px rgba(15,23,42,.04);
    }
    textarea{min-height:120px; resize:vertical; font-family:"Space Grotesk", "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;}
    textarea::placeholder{color:#94a3b8;}

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      box-shadow:0 12px 30px rgba(15,23,42,.05);
    }
    .btn:hover{border-color:#cbd5e1; background:#fafafa;}
    .btn:active{transform:translateY(1px);}
    .btn.primary{
      background:linear-gradient(120deg, var(--accent), var(--accent-2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 12px 35px rgba(79,70,229,.35);
    }
    .btn.primary:hover{filter:brightness(1.05);}
    .btn.danger{color:#b91c1c; border-color:#fecaca; background:#fff5f5;}
    .btn.small{padding:7px 10px; font-size:13px; border-radius:10px;}

    .actions{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    .actions.action-row,
    .actions.queue-actions{
      justify-content:center;
      flex-wrap:nowrap;
      width:100%;
    }
    .actions.action-row .btn,
    .actions.queue-actions .btn,
    .actions.queue-actions .status{
      white-space:nowrap;
    }
    .status{
      font-size:14px; color:var(--muted);
    }
    .status.error{color:var(--danger);}

    /* Queue list */
    .queue{
      display:grid; gap:8px; margin-top:8px;
      max-height:260px; overflow:auto; padding-right:2px;
    }
    .q-item{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:8px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      background:#fff;
      align-items:center;
    }
    .q-meta{
      font-size:12px; color:var(--muted);
      display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;
    }
    .pill{
      font-size:12px; background:#f1f5f9; padding:2px 7px; border-radius:999px;
    }

    /* Output gallery */
    .out-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
      gap:12px; margin-top:10px;
    }
    .out-item{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      display:grid;
      box-shadow:0 12px 30px rgba(15,23,42,.06);
      transition: transform .12s ease, box-shadow .2s ease;
    }
    .out-item:hover{transform:translateY(-2px); box-shadow:0 14px 40px rgba(15,23,42,.08);}
    .out-item img{
      width:100%; height:auto; display:block;
      cursor:zoom-in;
    }
    .out-meta{
      padding:10px 12px;
      font-size:12px; color:var(--muted);
      display:grid; gap:6px;
    }
    .out-row{
      display:flex; flex-wrap:wrap; gap:6px; align-items:center;
    }
    .download{
      margin-left:auto;
      text-decoration:none;
      color:var(--ink);
      font-weight:700;
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border);
      padding:5px 8px; border-radius:10px;
      background:#fff;
    }
    .download:hover{background:#fafafa; border-color:#cbd5e1;}
    code.small{
      font-size:11px; background:#f8fafc; padding:2px 5px; border-radius:6px;
      border:1px solid var(--border); color:#334155;
      word-break:break-all;
    }

    /* Progress bar */
    .progress{
      position:relative;
      height:12px;
      background:#e2e8f0;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--border);
      box-shadow: inset 0 1px 2px rgba(15,23,42,.05);
    }
    .progress .bar{
      position:absolute;
      inset:0;
      width:0%;
      background:linear-gradient(120deg, var(--accent), var(--accent-2));
      transition: width .2s ease;
    }
    .progress-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:var(--muted);
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:1000;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .modal-backdrop.show{
      opacity:1;
      pointer-events:auto;
    }
    .modal-content{
      background:#0f172a;
      border-radius:16px;
      overflow:hidden;
      max-width:90vw;
      max-height:90vh;
      box-shadow:0 24px 80px rgba(0,0,0,.35);
      position:relative;
    }
    .modal-content img{
      display:block;
      width:100%;
      height:auto;
      max-height:90vh;
      object-fit:contain;
      background:#0b1223;
    }
    .modal-close{
      position:absolute;
      top:10px;
      right:10px;
      border:none;
      width:32px;
      height:32px;
      border-radius:50%;
      background:rgba(15,23,42,.75);
      color:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
    }

    /* Header */
    .hero{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .logo{
      width:48px; height:48px;
      border-radius:14px;
      background:radial-gradient(circle at 20% 20%, #ffffff 10%, rgba(255,255,255,0) 45%),
                 linear-gradient(135deg, var(--accent), var(--accent-2));
      display:grid; place-items:center;
      color:#fff;
      font-weight:800;
      letter-spacing:-0.5px;
      box-shadow:0 12px 30px rgba(79,70,229,.45);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.35);
    }
    .pill.soft{background:var(--accent-soft); color:var(--accent); font-weight:700;}
    .section-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      color:var(--ink);
      margin-bottom:4px;
    }
    .section-title .pill{margin-left:auto;}

    @media(max-width:720px){
      body{padding:14px;}
      .card{padding:14px;}
      .hero{flex-direction:column; align-items:flex-start;}
      .actions{gap:6px;}
      .actions.action-row,
      .actions.queue-actions{flex-wrap:wrap; justify-content:flex-start;}
      .seg button{padding:8px 10px;}
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="card frosted">
    <div class="hero">
      <div class="logo">IQ</div>
      <div>
        <h1>Image Generator</h1>
      </div>
    </div>
  </div>

  <!-- Controls + Queue -->
  <div class="grid cols-2">

    <!-- Left: Controls -->
    <div class="card grid" style="gap:10px;">
      <div class="grid cols-3">
        <div>
          <div class="label">Model</div>
          <div class="seg" id="modelSeg" style="--count:2; --index:0;">
            <div class="slider"></div>
            <button data-value="gpt-image-1" class="active">gpt-image-1</button>
            <button data-value="gpt-image-1-mini">mini</button>
          </div>
        </div>
        <div>
          <div class="label">Quality</div>
          <div class="seg" id="qualitySeg" style="--count:3; --index:0;">
            <div class="slider"></div>
            <button data-value="low" class="active">Low</button>
            <button data-value="medium">Med</button>
            <button data-value="high">High</button>
          </div>
        </div>
        <div>
          <div class="label">Size</div>
          <div class="seg" id="sizeSeg" style="--count:3; --index:0;">
            <div class="slider"></div>
            <button data-value="1024x1024" data-label="Square" aria-label="Square" title="Square">
              <span class="aspect-icon square"></span>
              <span class="sr-only">Square</span>
            </button>
            <button data-value="1024x1536" data-label="Portrait" aria-label="Portrait" title="Portrait">
              <span class="aspect-icon portrait"></span>
              <span class="sr-only">Portrait</span>
            </button>
            <button data-value="1536x1024" data-label="Landscape" aria-label="Landscape" title="Landscape">
              <span class="aspect-icon landscape"></span>
              <span class="sr-only">Landscape</span>
            </button>
          </div>
        </div>
      </div>

      <div>
        <div class="label">Prompt</div>
        <textarea id="prompt" placeholder="Write a prompt you love, then queue it up."></textarea>
      </div>

      <div class="actions action-row">
        <button class="btn" id="addBtn"><i class="fa-solid fa-plus"></i> Queue</button>
        <button class="btn" id="addLinesBtn"><i class="fa-solid fa-list"></i> Each Line</button>
        <button class="btn danger" id="clearQueueBtn"><i class="fa-solid fa-trash"></i> Queue</button>
      </div>
    </div>

    <!-- Right: Queue -->
    <div class="card">
      <div class="section-title">
        Queue
        <span class="pill soft" id="qCount">0 jobs</span>
      </div>

      <div class="actions queue-actions" style="margin-bottom:6px;">
        <button class="btn primary" id="runBtn">
          <i class="fa-solid fa-play"></i> Run Queue
        </button>
        <button class="btn" id="stopBtn" disabled>
          <i class="fa-solid fa-stop"></i> Stop After Current
        </button>
        <span class="status" id="status"></span>
      </div>

      <div class="progress-row" id="progressRow" style="display:none;">
        <div class="progress" aria-hidden="true">
          <div class="bar" id="progressBar"></div>
        </div>
        <span id="progressText"></span>
      </div>

      <div class="queue" id="queue"></div>
    </div>
  </div>

  <!-- Output -->
  <div class="card">
    <div class="section-title">
      Output
      <button class="btn small" id="clearOutBtn"><i class="fa-solid fa-broom"></i> Clear</button>
    </div>
    <div class="out-grid" id="output"></div>
  </div>

</div>

<div class="modal-backdrop" id="imageModal" aria-hidden="true">
  <div class="modal-content">
    <button class="modal-close" id="closeModal" aria-label="Close image preview">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <img id="modalImage" alt="Preview" />
  </div>
</div>

<script>
  // ---------- Segmented controls w/ sliding highlight ----------
  function setupSeg(id, defaultValue, withLabel=false){
    const seg = document.getElementById(id);
    const buttons = Array.from(seg.querySelectorAll("button"));
    let value = defaultValue;
    let label = buttons.find(b=>b.dataset.value===defaultValue)?.dataset.label || "";

    function setActive(idx){
      buttons.forEach(b=>b.classList.remove("active"));
      buttons[idx].classList.add("active");
      seg.style.setProperty("--index", idx);
      value = buttons[idx].dataset.value;
      label = buttons[idx].dataset.label || buttons[idx].textContent.trim();
    }
    buttons.forEach((btn, idx)=>{
      btn.addEventListener("click", ()=> setActive(idx));
    });
    // init
    const defIdx = buttons.findIndex(b=>b.dataset.value===defaultValue);
    setActive(defIdx >= 0 ? defIdx : 0);

    return ()=> withLabel ? { value, label } : value;
  }

  const getModel = setupSeg("modelSeg", "gpt-image-1");
  const getQuality = setupSeg("qualitySeg", "low");
  const getSize = setupSeg("sizeSeg", "1024x1024", true);

  // ---------- Elements ----------
  const promptEl = document.getElementById("prompt");
  const queueEl = document.getElementById("queue");
  const outputEl = document.getElementById("output");
  const statusEl = document.getElementById("status");
  const qCountEl = document.getElementById("qCount");
  const progressRowEl = document.getElementById("progressRow");
  const progressBarEl = document.getElementById("progressBar");
  const progressTextEl = document.getElementById("progressText");
  const imageModalEl = document.getElementById("imageModal");
  const modalImageEl = document.getElementById("modalImage");
  const closeModalEl = document.getElementById("closeModal");

  const addBtn = document.getElementById("addBtn");
  const addLinesBtn = document.getElementById("addLinesBtn");
  const clearQueueBtn = document.getElementById("clearQueueBtn");
  const runBtn = document.getElementById("runBtn");
  const stopBtn = document.getElementById("stopBtn");
  const clearOutBtn = document.getElementById("clearOutBtn");

  const STORAGE_KEY = "image-generator-outputs";
  const savedOutputs = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  function setStatus(msg, isError=false){
    statusEl.textContent = msg || "";
    statusEl.classList.toggle("error", !!isError);
  }

  function persistOutputs(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(savedOutputs));
  }

  function openModal(src, alt){
    modalImageEl.src = src;
    modalImageEl.alt = alt || "Preview";
    imageModalEl.classList.add("show");
    imageModalEl.setAttribute("aria-hidden", "false");
  }

  function closeModal(){
    imageModalEl.classList.remove("show");
    imageModalEl.setAttribute("aria-hidden", "true");
    modalImageEl.src = "";
  }

  imageModalEl.addEventListener("click", (e)=>{
    if(e.target === imageModalEl) closeModal();
  });
  closeModalEl.addEventListener("click", closeModal);

  function updateProgress(current, total){
    if(total <= 0){
      progressRowEl.style.display = "none";
      progressBarEl.style.width = "0%";
      progressTextEl.textContent = "";
      return;
    }
    const pct = Math.round((current / total) * 100);
    progressRowEl.style.display = "flex";
    progressBarEl.style.width = `${pct}%`;
    progressTextEl.textContent = `${current}/${total}`;
  }

  // ---------- Queue state ----------
  const jobs = [];
  let running = false;
  let stopRequested = false;

  function renderQueue(){
    queueEl.innerHTML = "";
    jobs.forEach((job, i)=>{
      const div = document.createElement("div");
      div.className = "q-item";
      div.innerHTML = `
        <div>
          <div><strong>#${i+1}</strong> ${job.prompt}</div>
          <div class="q-meta">
            <span class="pill">${job.model}</span>
            <span class="pill">${job.quality}</span>
            <span class="pill">${job.sizeLabel || job.size}</span>
          </div>
        </div>
        <div class="actions" style="justify-content:flex-end;">
          <button class="btn small danger" data-remove="${i}">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      `;
      queueEl.appendChild(div);
    });

    qCountEl.textContent = `${jobs.length} job${jobs.length===1?"":"s"}`;
    // remove buttons
    queueEl.querySelectorAll("[data-remove]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.dataset.remove);
        jobs.splice(idx,1);
        renderQueue();
      });
    });
  }

  function addJob(prompt){
    const sizeSelection = getSize();
    jobs.push({
      prompt,
      model: getModel(),
      quality: getQuality(),
      size: sizeSelection.value,
      sizeLabel: sizeSelection.label
    });
    renderQueue();
  }

  addBtn.addEventListener("click", ()=>{
    const p = promptEl.value.trim();
    if(!p) return setStatus("Enter a prompt first.", true);
    addJob(p);
    promptEl.value = "";
    setStatus("");
  });

  addLinesBtn.addEventListener("click", ()=>{
    const raw = promptEl.value.trim();
    if(!raw) return setStatus("Enter prompts first.", true);
    raw.split("\n").map(s=>s.trim()).filter(Boolean).forEach(addJob);
    promptEl.value = "";
    setStatus("");
  });

  clearQueueBtn.addEventListener("click", ()=>{
    jobs.length = 0;
    renderQueue();
    setStatus("");
  });

  clearOutBtn.addEventListener("click", ()=>{
    outputEl.innerHTML = "";
    savedOutputs.length = 0;
    persistOutputs();
  });

  // ---------- Output cards ----------
  function addOutputCard({ dataUrl, prompt, model, quality, size, sizeLabel, createdAt }, shouldSave=true){
    const item = document.createElement("div");
    item.className = "out-item";

    const filename = prompt.slice(0,40).replace(/[^\w\-]+/g,"_") || "image";
    item.innerHTML = `
      <img src="${dataUrl}" alt="${prompt.replace(/"/g,"&quot;")}"/>
      <div class="out-meta">
        <div class="out-row">
          <span class="pill">${model}</span>
          <span class="pill">${quality}</span>
          <span class="pill">${sizeLabel || size}</span>

          <a class="download" download="${filename}.png" href="${dataUrl}">
            <i class="fa-solid fa-download"></i> Download
          </a>
        </div>
        <div>${prompt}</div>
      </div>
    `;
    const imgEl = item.querySelector("img");
    imgEl.addEventListener("click", ()=> openModal(dataUrl, prompt));
    outputEl.prepend(item);

    if(shouldSave){
      const entry = { dataUrl, prompt, model, quality, size, sizeLabel, createdAt: createdAt || Date.now() };
      savedOutputs.unshift(entry);
      if(savedOutputs.length > 20) savedOutputs.length = 20;
      persistOutputs();
    }
  }

  savedOutputs.forEach(entry => addOutputCard(entry, false));

  // ---------- API call ----------
  async function generateOne(job){
    const res = await fetch("/api/generate-image",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        prompt: job.prompt,
        model: job.model,
        quality: job.quality,
        size: job.size,
        n: 1
      })
    });
    const text = await res.text().catch(()=> "");
    if(!res.ok) throw new Error(text || `Request failed (${res.status})`);
    return JSON.parse(text);
  }

  // ---------- Run queue sequentially ----------
  runBtn.addEventListener("click", async ()=>{
    if(running) return;
    if(jobs.length===0) return setStatus("Queue is empty.", true);

    running = true;
    stopRequested = false;
    runBtn.disabled = true;
    stopBtn.disabled = false;
    const total = jobs.length;
    updateProgress(0, total);

    try{
      for(let i=0; i<jobs.length; i++){
        setStatus(`Running ${i+1}/${jobs.length}…`);
        const job = jobs[i];

        const data = await generateOne(job);
        // expecting { images: [{ dataUrl }] }
        const img = data?.images?.[0];
        if(!img?.dataUrl) throw new Error("No image returned.");

        addOutputCard({
          dataUrl: img.dataUrl,
          prompt: job.prompt,
          model: job.model,
          quality: job.quality,
          size: job.size,
          sizeLabel: job.sizeLabel
        });

        updateProgress(i+1, total);

        if(stopRequested){
          setStatus("Stopped after current job.");
          break;
        }
      }
    }catch(err){
      console.error(err);
      setStatus(err.message || "Something went wrong.", true);
    }finally{
      updateProgress(0,0);
      running = false;
      runBtn.disabled = false;
      stopBtn.disabled = true;
    }
  });

  stopBtn.addEventListener("click", ()=>{
    if(!running) return;
    stopRequested = true;
    setStatus("Stop requested… will stop after current job.");
  });

  renderQueue();
</script>
</body>
</html>
